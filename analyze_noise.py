#!/usr/bin/env python3
"""
Analyze noise magnitude from diagnostic output.
Computes β·e0[0] = decryption_term - β·s[0] and checks if it exceeds encoding tolerance.
"""

# Extract values from diagnostic output
beta_s0 = [
    477734480, 475713040, 892072328, 303327583, 724667897, 150403453, 506157470, 86364298,
    516702557, 179906783, 688016851, 882188127, 378717904, 659809004, 435807012, 177905707,
    921756774, 645841884, 119252566, 280134204, 136518640, 756376971, 328047961, 32903176,
    207936704, 1045990549, 994803344, 717475341, 876238489, 801105091, 1003550921, 518798145,
    642336096, 1000671540, 410617862, 114246781, 945947098, 38200072, 997590761, 28003734,
    128704846, 627795119, 952367140, 862504451, 702605522, 616199153, 992022815, 541522863,
    694252312, 322888021, 416400096, 74024540, 324478836, 496348266, 420000513, 99020812,
    488881632, 1031094415, 4399431, 635640354, 7725194, 1049960825, 4255674, 241671297,
    631649529, 985028617, 896729787, 166145611, 31542940, 858570204, 772743120, 732929298,
    1043555032, 606842406, 439775547, 224244697, 292358586, 889384809, 249063080, 207988483,
    584339503, 109252720, 432363406, 184626429, 712891752, 907251537, 170624282, 373910551,
    815006834, 1021629367, 870908039, 156332942, 320334359, 32355411, 521465165, 765921716,
    469724760, 231349806, 627482860, 1008640098, 770774576, 452512355, 144366370, 407089433,
    100336342, 62306136, 973889865, 596852604, 81473132, 545502353, 193457387, 908338802,
    653115789, 380951891, 631562767, 1003273526, 840555972, 830782779, 998178661, 854165952,
    475161523, 891416227, 31187826, 247184093, 899421382, 556310402, 1061109819, 410688324,
    649893273, 432306423, 813795998, 645645191, 911439314, 584545681, 952075116, 469964945,
    478337139, 206215122, 575734903, 980163565, 698489903, 466833173, 467539678, 295442052,
    980712035, 101614524, 227031155, 490914483, 497678594, 1032802584, 84026394, 262201332,
    418438307, 201216070, 848803466, 165359649, 357325412, 585282145, 138181371, 163952124,
    629658879, 433320960, 219193836, 272767515, 498339737, 892865875, 501464318, 368390394,
    1054832563, 554951735, 211260377, 217424071, 365188169, 240455771, 270335194, 977428880,
    945243100, 378316366, 297915622, 375693431, 250331120, 111277961, 627980868, 589968104,
    606673789, 507563587, 439896496, 642371954, 950017581, 624799934, 720850659, 1072947632,
    653522736, 938186258, 442465800, 500511190, 1002555553, 502223179, 991926162, 832322298,
    728844288, 599593958, 652767045, 406647722, 439958064, 256186509, 142490407, 875088819,
    569463043, 1009274504, 493578491, 779252264, 1072412037, 482775065, 482623655, 498832756,
    407244292, 682411910, 531497670, 559374322, 842764071, 578483595, 48206903, 305762344,
    616532620, 401974378, 494008737, 707347351, 653215670, 325059032, 1025948260, 376150058,
    36756318, 454318625, 517470512, 533419251, 838443712, 420215842, 1013652541, 154205280,
    562295962, 136488245, 415802863, 417526929, 881516650, 100632670, 267353617, 712451904,
    412033994, 355864457, 716550735, 401285259, 7707281, 175577004, 295890098, 572034884
]

decryption_term = [
    223414220, 124676789, 861923787, 430914295, 937272934, 234532876, 789173588, 210659285,
    785340131, 977164456, 220139326, 953653286, 872419927, 362674228, 914308520, 368588646,
    860534006, 640777842, 749817905, 651416259, 225930467, 578610484, 542745902, 764997057,
    58973459, 300751066, 656765556, 391539609, 140390808, 243843692, 575463209, 356291160,
    1068668438, 97360154, 905226329, 130531830, 437187827, 39196126, 768972739, 132079421,
    499741380, 842721070, 41722526, 661355698, 669650608, 46591697, 487891720, 467739104,
    506603867, 240437656, 492412606, 198566874, 550689942, 410570312, 572164530, 270491724,
    754174702, 420113813, 115390417, 828672427, 518262500, 639365707, 63130681, 796558617,
    605551889, 178543751, 272777960, 613916832, 436998201, 854829121, 561581843, 108616711,
    485614928, 490913044, 700044915, 36542418, 824704852, 304930203, 790181303, 478053470,
    149795469, 827637299, 260217621, 205430763, 998204139, 876989557, 272695191, 161066005,
    322993174, 539494578, 46116724, 991475270, 167976702, 691007485, 102537530, 572985660,
    672889673, 9962978, 235376842, 1048338903, 610715066, 152329129, 265095219, 527359069,
    747831713, 473062517, 687853209, 329677187, 322719747, 319792037, 167322003, 581584480,
    767464665, 1050491954, 1072658224, 615998677, 890445337, 638603636, 1069061460, 349024219,
    465969108, 628210780, 164473435, 658808961, 898178790, 230079962, 59172396, 24082807,
    83740362, 553441114, 597793533, 351754531, 700320559, 211163630, 877162487, 774339961,
    626826935, 543707474, 863594279, 108886808, 204419773, 756369206, 62893758, 871249504,
    35068249, 87110290, 964861395, 661048741, 65658996, 25888371, 904507284, 704098410,
    914004515, 487289157, 454527112, 985253446, 352505434, 219797337, 472833606, 636514336,
    283340002, 719753657, 176567979, 785340683, 863358365, 846985028, 44731626, 335882004,
    399550531, 1023393320, 596995978, 467297489, 239918524, 1057357689, 264713768, 539823366,
    430988857, 781586466, 425878718, 800386780, 741974270, 677389788, 193772187, 337883087,
    433077315, 113919631, 899402050, 223387044, 323091993, 412472432, 424460811, 605026298,
    990570596, 393225767, 996912, 825008962, 27094537, 274466602, 689901049, 623226133,
    736813981, 854863620, 488818961, 580962728, 512269418, 303545248, 513012676, 854191494,
    513373412, 587308500, 946757522, 351275740, 408918984, 547185069, 51214212, 859335213,
    780332731, 712160240, 69765144, 975238825, 436732056, 855677097, 887293810, 508152104,
    40201085, 685465719, 623940978, 903885190, 934990106, 836095344, 304639100, 952386920,
    793325287, 631766888, 688732096, 99372948, 779898761, 529883970, 130853511, 94852264,
    859150884, 945442968, 669835195, 692464494, 859437017, 151432163, 248469782, 101223147,
    532683347, 1000457371, 101662176, 629259381, 302215774, 585032095, 808483895, 400222694
]

PARAM_Q = 1073741441
PARAM_K = 30
shift = PARAM_K - 8  # 22
encoding_tolerance = 1 << shift  # 2^22 = 4194304

print("=" * 80)
print("NOISE ANALYSIS: Computing β·e0[0] = decryption_term - β·s[0]")
print("=" * 80)
print(f"PARAM_Q = {PARAM_Q}")
print(f"Encoding tolerance (2^{shift}) = {encoding_tolerance} (0x{encoding_tolerance:x})")
print()

# Compute β·e0[0] = decryption_term - β·s[0] (mod Q)
beta_e0_0 = []
for i in range(len(beta_s0)):
    diff = (decryption_term[i] - beta_s0[i]) % PARAM_Q
    # Centered lift: if diff > Q/2, subtract Q
    if diff > PARAM_Q // 2:
        diff = diff - PARAM_Q
    beta_e0_0.append(diff)

# Find max absolute value
max_abs_noise = max(abs(x) for x in beta_e0_0)
max_abs_noise_idx = max(range(len(beta_e0_0)), key=lambda i: abs(beta_e0_0[i]))
min_abs_noise = min(abs(x) for x in beta_e0_0 if x != 0)

print(f"β·e0[0] noise statistics:")
print(f"  Max |β·e0[0]|: {max_abs_noise} (at index {max_abs_noise_idx})")
print(f"  Min |β·e0[0]|: {min_abs_noise}")
print(f"  Encoding tolerance: {encoding_tolerance}")
print()

# Check how many coefficients exceed tolerance
exceed_count = sum(1 for x in beta_e0_0 if abs(x) > encoding_tolerance)
print(f"Coefficients exceeding tolerance ({encoding_tolerance}): {exceed_count}/{len(beta_e0_0)} ({100*exceed_count/len(beta_e0_0):.1f}%)")
print()

# Show first 32 coefficients (where k_log is encoded)
print("First 32 coefficients (where k_log is encoded):")
print("  Index | β·s[0]      | decryption_term | β·e0[0]      | |β·e0[0]|  | Exceeds?")
print("  " + "-" * 75)
for i in range(min(32, len(beta_e0_0))):
    exceeds = "YES" if abs(beta_e0_0[i]) > encoding_tolerance else "no"
    print(f"  {i:5d} | {beta_s0[i]:11d} | {decryption_term[i]:15d} | {beta_e0_0[i]:12d} | {abs(beta_e0_0[i]):10d} | {exceeds}")
print()

# Check if noise affects k_log extraction
print("=" * 80)
print("IMPACT ON k_log EXTRACTION:")
print("=" * 80)
print(f"k_log is encoded in upper {shift} bits (positions {shift} to 31)")
print(f"Max noise magnitude: {max_abs_noise}")
print(f"Encoding tolerance: {encoding_tolerance}")
print()

if max_abs_noise > encoding_tolerance:
    print(f"⚠️  CRITICAL: Max noise ({max_abs_noise}) EXCEEDS encoding tolerance ({encoding_tolerance})")
    print(f"   This WILL corrupt k_log extraction in high bits!")
    print()
    print("Possible solutions:")
    print("  1. Further reduce e0[0] noise (currently at 0.5× sigma)")
    print("  2. Use smaller encoding shift (reduce from 22 to smaller value)")
    print("  3. Use error correction codes (Reed-Solomon, etc.)")
    print("  4. Increase PARAM_K to allow larger shift")
    print("  5. Use different encoding scheme (e.g., encode in lower bits)")
else:
    print(f"✓ Max noise ({max_abs_noise}) is within encoding tolerance ({encoding_tolerance})")
    print("  k_log extraction should work correctly")

print()
print("=" * 80)

