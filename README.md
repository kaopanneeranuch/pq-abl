# Log Anchoring & Verification System

This project implements a blockchain-based log integrity system. It generates logs, computes their Merkle root, stores the data on IPFS, and anchors the cryptographic proof (Merkle Root and CIDs) to a local Ethereum blockchain (Anvil). This ensures that log data cannot be tampered with without detection.

##  Prerequisites

Ensure the following tools and dependencies are installed on your system:

- **Rust Toolchain:** `cargo` (for building the Merkle tree tool)
- **Foundry:** `anvil`, `forge`, `cast` (for blockchain simulation and interaction)
- **IPFS:** `ipfs` CLI (kubo) must be installed and the daemon running.
- **Python 3:** Required for log generation scripts.
- **Utilities:** `sha3sum`, `tar`, `awk`, `find`, `xargs`.

##  Setup & Installation

### 1. Build the Merkle Tree Tool
Compile the Rust binary used for computing Merkle roots and proofs.

```bash
bash build.sh
```

### 2. Start Local Blockchain
Start the Anvil local testnet in a separate terminal window.

```bash
anvil
```

### 3. Environment Configuration
From the Anvil output, copy a private key to use for deployment.

```bash
# Replace <private-key> with one of the keys generated by Anvil
export PRIVATE_KEY="<private-key>"
```

### 4. Smart Contract Deployment
Deploy the anchoring and receipt verification contracts.

```bash
# Deploy Anchoring Contract
forge script smart-contract/script/anchoring-commit.s.sol \
  --private-key $PRIVATE_KEY \
  --rpc-url http://localhost:8545 \
  --broadcast

# Deploy Verify Receipt Contract
forge script smart-contract/script/verify-receipt.s.sol \
  --private-key $PRIVATE_KEY \
  --rpc-url http://localhost:8545 \
  --broadcast
```

Once deployed, export the contract addresses (found in the deployment output) to your environment:

```bash
export ANCHORCONTRACT_ADDR="<anchorContract address>"
export RECEIPTCONTRACT_ADDR="<receiptContract address>"
```

---

## ðŸ”„ Workflow

### Phase 1: Log Generation & Preparation

Generate dummy logs, compute their SHA3-256 hashes, and archive them.

```bash
# 1. Generate dummy logs
echo "Generating logs..."
python3 gen_log.py -n 10000 -e 1 --start-days 30 --prefix log

# 2. Compute hashes for all log files (pre-Merkle tree processing)
echo "Hashing logs..."
find ./logs -type f -print0 | sort -z | xargs -r0 sha3sum -a 256 | awk '{ print $1 }' > log_digest 

# 3. Compress logs and cleanup
echo "Compressing logs and cleaning up raw files..."
tar -czvf epoch1.tar.gz ./logs/* rm -rf ./logs
```

### Phase 2: Storage (IPFS) & Computation

Upload the compressed logs to IPFS and compute the Merkle Root.

```bash
# 1. Upload compressed logs to IPFS
echo "Uploading logs to IPFS..."
IPFS_CT_CID=$(ipfs add epoch1.tar.gz | awk '{ print $2 }') 

# 2. Compute Merkle Root and generate temporary proof
echo "Computing Merkle Root..."
./merkle-tree-arm64 compute ./log_digest

# 3. Upload the proof file to IPFS
echo "Uploading proof to IPFS..."
IPFS_PROOF_CID=$(ipfs add temp_proof | awk '{ print $2 }')

# 4. Capture the Root Hash
ROOT=$(cat temp_root)

# 5. Cleanup temporary files
rm temp_proof temp_root log_digest
```

### Phase 3: Anchoring to Blockchain

Commit the Merkle Root and IPFS CIDs to the smart contract.

```bash
cast send $ANCHORCONTRACT_ADDR \
  "createRecordMap(string,string,string)" \
  $ROOT $IPFS_PROOF_CID $IPFS_CT_CID \
  --private-key $PRIVATE_KEY 
```

---

## ðŸ” Verification Process

This process retrieves the data from the blockchain, downloads the files from IPFS, and verifies that the current logs match the anchored Merkle Root.

### 1. Retrieve Anchored Data
Fetch the Root and CIDs stored on the blockchain.

```bash
# Fetch data and parse into a temp file
cast call $ANCHORCONTRACT_ADDR "getAllInfoCurrentMapper()((string,string,string)[])" \
  --private-key $PRIVATE_KEY \
  | awk -F'"' '{print $2, $4, $6}' | column -t > temp_env

# Read into variables
GET_ROOT=$(cat temp_env | awk '{ print $1 }')
GET_IPFS_PROOF_CID=$(cat temp_env | awk '{ print $2 }')
GET_IPFS_CT_CID=$(cat temp_env | awk '{ print $3 }')
```

### 2. Download & Verify Integrity
Download the logs and proof from IPFS, re-hash the logs, and run the Merkle verification.

```bash
# 1. Prepare local files
echo $GET_ROOT > ./epoch1_root

# 2. Download from IPFS
ipfs get $GET_IPFS_PROOF_CID -o ./epoch1_proof
ipfs get $GET_IPFS_CT_CID -o ./epoch1.tar.gz

# 3. Extract and Re-hash
tar -xzvf ./epoch1.tar.gz
find ./logs -type f -print0 | sort -z | xargs -r0 sha3sum -a 256 | awk '{ print $1 }' > epoch1_digest 

# 4. Verify against the Merkle Root
./merkle-tree-arm64 verify ./epoch1_proof ./epoch1_digest ./epoch1_root > temp_verify

# Check temp_verify content for "True" or "Success"
cat temp_verify
```

---

##  Benchmark

To run the automated benchmark script:

```bash
bash mockup_ver.sh
```
